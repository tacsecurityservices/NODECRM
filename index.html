<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NODE CRM</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        #admin-login-screen, #agent-login-screen, #receptionist-login-screen {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 100px; position: relative; }
        .appointment-badge { 
            font-size: 0.65rem; 
            line-height: 1.2; 
            margin-top: 2px; 
            padding: 2px 4px; 
            border-radius: 3px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            cursor: pointer; 
        }
        .status-new { background-color: #DBEAFE; color: #1E40AF; }
        .status-noanswer { background-color: #FEF3C7; color: #92400E; }
        .status-voicemail { background-color: #F3E8FF; color: #6B21A8; }
        .status-callback { background-color: #E0F2FE; color: #075985; }
        .status-appointment { background-color: #D1FAE5; color: #065F46; }
        .status-closed { background-color: #FEE2E2; color: #991B1B; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Portal Selection -->
    <div id="portal-selection" class="fixed inset-0 z-[100] flex items-center justify-center p-4" style="background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">NODE CRM</h1>
                <p class="text-gray-500">Choose your portal to continue</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <button onclick="selectPortal('admin')" class="group p-8 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full mx-auto mb-4 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Admin Console</h3>
                    <p class="text-sm text-gray-600">Manage agents, leads & calendar</p>
                </button>
                <button onclick="selectPortal('agent')" class="group p-8 border-2 border-gray-200 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition">
                    <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Agent Portal</h3>
                    <p class="text-sm text-gray-600">Manage leads & book appointments</p>
                </button>
                <button onclick="selectPortal('receptionist')" class="group p-8 border-2 border-gray-200 rounded-xl hover:border-teal-500 hover:bg-teal-50 transition">
                    <div class="w-16 h-16 bg-teal-100 text-teal-600 rounded-full mx-auto mb-4 flex items-center justify-center group-hover:bg-teal-600 group-hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Receptionist</h3>
                    <p class="text-sm text-gray-600">View all bookings & client info</p>
                </button>
            </div>
        </div>
    </div>

    <!-- Login Screens -->
    <div id="admin-login-screen" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <button onclick="backToPortalSelection()" class="mb-4 text-gray-500 hover:text-gray-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back
            </button>
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900">Admin Login</h2>
            </div>
            <form id="admin-login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="admin-email" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-red-500" placeholder="admin@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-pass" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-red-500" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition">Login</button>
            </form>
            <div id="admin-login-error" class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 hidden text-center">Invalid credentials</div>
        </div>
    </div>

    <div id="agent-login-screen" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <button onclick="backToPortalSelection()" class="mb-4 text-gray-500 hover:text-gray-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back
            </button>
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900">Agent Login</h2>
            </div>
            <form id="agent-login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="agent-email" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="agent@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="agent-pass" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition">Login</button>
            </form>
            <div id="agent-login-error" class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 hidden text-center">Invalid credentials</div>
        </div>
    </div>

    <div id="receptionist-login-screen" class="fixed inset-0 z-[100] hidden flex items-center justify-center p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <button onclick="backToPortalSelection()" class="mb-4 text-gray-500 hover:text-gray-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back
            </button>
            <div class="text-center mb-8">
                <h2 class="text-2xl font-bold text-gray-900">Receptionist Login</h2>
            </div>
            <form id="receptionist-login-form" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Email</label>
                    <input type="email" id="receptionist-email" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-teal-500" placeholder="reception@example.com">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="receptionist-pass" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-teal-500" placeholder="••••••••">
                </div>
                <button type="submit" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg transition">Login</button>
            </form>
            <div id="receptionist-login-error" class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 hidden text-center">Invalid credentials</div>
        </div>
    </div>

    <div id="admin-app" class="hidden"></div>
    <div id="agent-app" class="hidden"></div>
    <div id="receptionist-app" class="hidden"></div>

    <script>
        const GLOBAL_STATE = {
            adminCredentials: { email: 'admin@tac.co.za', pass: 'TacCRMS123!' },
            receptionistCredentials: { email: 'receptionist@tac.co.za', pass: 'Recep123!' },
            currentUser: null,
            userType: null,
            registeredAgents: [],
            agentLeads: {},
            appointments: [],
            calendarView: new Date(),
            agentLeadFilter: 'active',
            currentTargetAgentId: null,
            currentBookingLead: null
        };

        // ════════════════════════════════════════════════
        // NAVIGATION FUNCTIONS
        // ════════════════════════════════════════════════
        function selectPortal(type) {
            document.getElementById('portal-selection').classList.add('hidden');
            document.getElementById('admin-login-screen').style.display = type === 'admin' ? 'flex' : 'none';
            document.getElementById('agent-login-screen').style.display = type === 'agent' ? 'flex' : 'none';
            document.getElementById('receptionist-login-screen').style.display = type === 'receptionist' ? 'flex' : 'none';
        }

        function backToPortalSelection() {
            document.getElementById('portal-selection').classList.remove('hidden');
            document.getElementById('admin-login-screen').style.display = 'none';
            document.getElementById('agent-login-screen').style.display = 'none';
            document.getElementById('receptionist-login-screen').style.display = 'none';
        }

        function logout() {
            GLOBAL_STATE.currentUser = null;
            GLOBAL_STATE.userType = null;
            ['admin-app', 'agent-app', 'receptionist-app'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            document.getElementById('portal-selection').classList.remove('hidden');
        }

        // ════════════════════════════════════════════════
        // LOGIN HANDLERS
        // ════════════════════════════════════════════════
        window.onload = function() {
            document.getElementById('admin-login-form').addEventListener('submit', e => {
                e.preventDefault();
                const email = document.getElementById('admin-email').value.trim();
                const pass = document.getElementById('admin-pass').value;
                if (email === GLOBAL_STATE.adminCredentials.email && pass === GLOBAL_STATE.adminCredentials.pass) {
                    GLOBAL_STATE.currentUser = { email, name: 'Admin' };
                    GLOBAL_STATE.userType = 'admin';
                    showAdminDashboard();
                } else {
                    document.getElementById('admin-login-error').classList.remove('hidden');
                    setTimeout(() => document.getElementById('admin-login-error').classList.add('hidden'), 3000);
                }
            });

            document.getElementById('agent-login-form').addEventListener('submit', e => {
                e.preventDefault();
                const email = document.getElementById('agent-email').value.trim();
                const pass = document.getElementById('agent-pass').value;
                const agent = GLOBAL_STATE.registeredAgents.find(a => a.email === email && a.password === pass);
                if (agent) {
                    GLOBAL_STATE.currentUser = agent;
                    GLOBAL_STATE.userType = 'agent';
                    showAgentDashboard();
                } else {
                    document.getElementById('agent-login-error').classList.remove('hidden');
                    setTimeout(() => document.getElementById('agent-login-error').classList.add('hidden'), 3000);
                }
            });

            document.getElementById('receptionist-login-form').addEventListener('submit', e => {
                e.preventDefault();
                const email = document.getElementById('receptionist-email').value.trim();
                const pass = document.getElementById('receptionist-pass').value;
                if (email === GLOBAL_STATE.receptionistCredentials.email && pass === GLOBAL_STATE.receptionistCredentials.pass) {
                    GLOBAL_STATE.currentUser = { email, name: 'Receptionist' };
                    GLOBAL_STATE.userType = 'receptionist';
                    showReceptionistDashboard();
                } else {
                    document.getElementById('receptionist-login-error').classList.remove('hidden');
                    setTimeout(() => document.getElementById('receptionist-login-error').classList.add('hidden'), 3000);
                }
            });
        };

        // ════════════════════════════════════════════════
        // ADMIN DASHBOARD
        // ════════════════════════════════════════════════
        function showAdminDashboard() {
            document.getElementById('admin-login-screen').style.display = 'none';
            const app = document.getElementById('admin-app');
            app.classList.remove('hidden');
            app.innerHTML = getAdminHTML();
            setTimeout(initializeAdminUI, 50);
            renderAdminAgents();
        }

        function getAdminHTML() {
            return `
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-extrabold text-gray-900">NODE CRM</h1>
                            <p class="text-gray-500">Admin Console</p>
                        </div>
                        <div class="flex gap-4">
                            <button id="admin-view-agents-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold">Agents</button>
                            <button id="admin-view-calendar-btn" class="bg-white border border-gray-200 px-6 py-2 rounded-lg font-semibold">Master Calendar</button>
                            <button onclick="logout()" class="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg">Sign Out</button>
                        </div>
                    </header>

                    <div id="admin-agent-section" class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border">
                                <h3 class="text-lg font-bold mb-6">Create New Agent</h3>
                                <form id="admin-create-agent-form" class="space-y-4">
                                    <div><input type="text" id="admin-new-agent-name" required placeholder="Agent Name" class="w-full border rounded-lg p-2.5"></div>
                                    <div><input type="email" id="admin-new-agent-email" required placeholder="Email" class="w-full border rounded-lg p-2.5"></div>
                                    <div><input type="text" id="admin-new-agent-pass" required placeholder="Password" class="w-full border rounded-lg p-2.5"></div>
                                    <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold">Register Agent</button>
                                </form>
                            </div>
                        </div>

                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-2xl shadow-sm border">
                                <div class="px-6 py-4 bg-gray-50 border-b flex justify-between">
                                    <h3 class="font-bold">Agents</h3>
                                    <span id="admin-agent-count" class="bg-indigo-100 text-indigo-700 px-2.5 py-1 rounded-full text-xs">0 Agents</span>
                                </div>
                                <table class="w-full">
                                    <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                                        <tr>
                                            <th class="px-6 py-3 text-left">Agent</th>
                                            <th class="px-6 py-3 text-left">Email</th>
                                            <th class="px-6 py-3 text-center">Leads</th>
                                            <th class="px-6 py-3 text-center">Appts</th>
                                            <th class="px-6 py-3 text-center">Closed</th>
                                            <th class="px-6 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-agent-list-body"></tbody>
                                </table>
                                <div id="admin-empty-state" class="p-12 text-center hidden">
                                    <p class="text-gray-400">No agents yet</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="admin-calendar-section" class="hidden mt-8">
                        <div class="bg-white rounded-2xl shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-4">
                                    <h2 id="admin-calendar-title" class="text-xl font-bold"></h2>
                                    <div class="flex gap-2">
                                        <button onclick="changeCalendarMonth(-1, 'admin')" class="p-2 hover:bg-gray-100 rounded">←</button>
                                        <button onclick="changeCalendarMonth(1, 'admin')" class="p-2 hover:bg-gray-100 rounded">→</button>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-600">All Appointments</span>
                            </div>
                            <div id="admin-calendar-grid" class="calendar-grid"></div>
                        </div>
                    </div>
                </div>
                ${getSharedModalsHTML()}`;
        }

        function initializeAdminUI() {
            const form = document.getElementById('admin-create-agent-form');
            if (form) {
                form.addEventListener('submit', e => {
                    e.preventDefault();
                    const name = document.getElementById('admin-new-agent-name').value.trim();
                    const email = document.getElementById('admin-new-agent-email').value.trim();
                    const pass = document.getElementById('admin-new-agent-pass').value.trim();
                    if (!name || !email || !pass) return alert('Fill all fields');
                    const agent = { id: Date.now().toString(), name, email, password: pass };
                    GLOBAL_STATE.registeredAgents.push(agent);
                    GLOBAL_STATE.agentLeads[agent.id] = [];
                    form.reset();
                    renderAdminAgents();
                    alert('Agent created successfully');
                });
            }

            document.getElementById('admin-view-agents-btn').addEventListener('click', () => {
                document.getElementById('admin-agent-section').classList.remove('hidden');
                document.getElementById('admin-calendar-section').classList.add('hidden');
            });

            document.getElementById('admin-view-calendar-btn').addEventListener('click', () => {
                document.getElementById('admin-agent-section').classList.add('hidden');
                document.getElementById('admin-calendar-section').classList.remove('hidden');
                renderAdminCalendar();
            });

            const dropZone = document.getElementById('admin-drop-zone');
            const fileInput = document.getElementById('admin-lead-file-input');
            if (dropZone && fileInput) {
                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', e => handleUploadFile(e.target.files[0]));
                dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('border-indigo-500'); });
                dropZone.addEventListener('dragleave', () => dropZone.classList.remove('border-indigo-500'));
                dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('border-indigo-500'); handleUploadFile(e.dataTransfer.files[0]); });
            }

            document.getElementById('admin-close-upload')?.addEventListener('click', closeUploadModal);
            document.getElementById('close-progress-modal')?.addEventListener('click', () => {
                document.getElementById('agent-progress-modal').classList.add('hidden');
            });
        }

        function handleUploadFile(file) {
            if (!file || !GLOBAL_STATE.currentTargetAgentId) return;
            const status = document.getElementById('admin-upload-status');
            status.classList.remove('hidden');
            status.textContent = 'Processing...';
            status.className = 'mt-4 p-3 rounded text-center bg-yellow-50 text-yellow-700';

            if (file.name.endsWith('.csv')) {
                Papa.parse(file, {
                    header: true,
                    complete: results => {
                        const newLeads = results.data.filter(row => row.name || row.Name).map(row => ({
                            id: Date.now() + Math.random().toString(36).slice(2),
                            name: row.name || row.Name,
                            email: row.email || row.Email,
                            phone: row.phone || row.Phone,
                            address: row.address || row.Address,
                            disposition: 'New Lead'
                        }));
                        GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentTargetAgentId].push(...newLeads);
                        status.textContent = `${newLeads.length} leads uploaded`;
                        status.className = 'mt-4 p-3 rounded text-center bg-green-50 text-green-700';
                        renderAdminAgents();
                        setTimeout(closeUploadModal, 2000);
                    }
                });
            } else if (file.name.endsWith('.json')) {
                const reader = new FileReader();
                reader.onload = e => {
                    try {
                        const data = JSON.parse(e.target.result);
                        const newLeads = Array.isArray(data) ? data.filter(item => item.name).map(item => ({
                            id: Date.now() + Math.random().toString(36).slice(2),
                            name: item.name,
                            email: item.email,
                            phone: item.phone,
                            address: item.address,
                            disposition: 'New Lead'
                        })) : [];
                        GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentTargetAgentId].push(...newLeads);
                        status.textContent = `${newLeads.length} leads uploaded`;
                        status.className = 'mt-4 p-3 rounded text-center bg-green-50 text-green-700';
                        renderAdminAgents();
                        setTimeout(closeUploadModal, 2000);
                    } catch (err) {
                        status.textContent = 'Error parsing JSON';
                        status.className = 'mt-4 p-3 rounded text-center bg-red-50 text-red-700';
                    }
                };
                reader.readAsText(file);
            }
        }

        function openUploadModal(agentId, agentName) {
            GLOBAL_STATE.currentTargetAgentId = agentId;
            document.getElementById('admin-target-agent-name').textContent = agentName;
            document.getElementById('admin-upload-modal').classList.remove('hidden');
            document.getElementById('admin-upload-status').classList.add('hidden');
        }

        function closeUploadModal() {
            document.getElementById('admin-upload-modal').classList.add('hidden');
            GLOBAL_STATE.currentTargetAgentId = null;
            document.getElementById('admin-lead-file-input').value = '';
        }

        function viewAgentProgress(agentId) {
            const agent = GLOBAL_STATE.registeredAgents.find(a => a.id === agentId);
            if (!agent) return;
            const leads = GLOBAL_STATE.agentLeads[agentId] || [];
            const totalLeads = leads.length;
            const activeLeads = leads.filter(l => l.disposition === 'New Lead').length;
            const disposedLeads = totalLeads - activeLeads;
            const bookings = GLOBAL_STATE.appointments.filter(a => a.agentId === agentId).length;
            const closed = leads.filter(l => l.disposition === 'Closed').length;

            document.getElementById('progress-agent-name').textContent = agent.name;
            document.getElementById('progress-total-leads').textContent = totalLeads;
            document.getElementById('progress-leads-left').textContent = activeLeads;
            document.getElementById('progress-disposed').textContent = disposedLeads;
            document.getElementById('progress-bookings').textContent = bookings;
            document.getElementById('progress-closed').textContent = closed;

            document.getElementById('agent-progress-modal').classList.remove('hidden');
        }

        function renderAdminAgents() {
            const tbody = document.getElementById('admin-agent-list-body');
            const countSpan = document.getElementById('admin-agent-count');
            const emptyState = document.getElementById('admin-empty-state');

            tbody.innerHTML = '';
            if (GLOBAL_STATE.registeredAgents.length === 0) {
                emptyState.classList.remove('hidden');
                countSpan.textContent = '0 Agents';
                return;
            }
            emptyState.classList.add('hidden');

            GLOBAL_STATE.registeredAgents.forEach(agent => {
                const leads = GLOBAL_STATE.agentLeads[agent.id] || [];
                const appts = GLOBAL_STATE.appointments.filter(a => a.agentId === agent.id).length;
                const closed = leads.filter(l => l.disposition === 'Closed').length;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium">${agent.name}</td>
                    <td class="px-6 py-4">${agent.email}</td>
                    <td class="px-6 py-4 text-center">${leads.length}</td>
                    <td class="px-6 py-4 text-center">${appts}</td>
                    <td class="px-6 py-4 text-center">${closed}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="openUploadModal('${agent.id}', '${agent.name}')" class="text-indigo-600 hover:text-indigo-800 mr-4">Upload Leads</button>
                        <button onclick="viewAgentProgress('${agent.id}')" class="text-green-600 hover:text-green-800">View Progress</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            countSpan.textContent = `${GLOBAL_STATE.registeredAgents.length} Agent${GLOBAL_STATE.registeredAgents.length > 1 ? 's' : ''}`;
        }

        // ════════════════════════════════════════════════
        // AGENT DASHBOARD
        // ════════════════════════════════════════════════
        function showAgentDashboard() {
            document.getElementById('agent-login-screen').style.display = 'none';
            const app = document.getElementById('agent-app');
            app.classList.remove('hidden');
            app.innerHTML = getAgentHTML();
            setTimeout(() => {
                setupAgentHandlers();
                renderAgentUI();
            }, 50);
        }

        function getAgentHTML() {
            return `
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-extrabold text-gray-900">Agent Dashboard</h1>
                            <p class="text-gray-500">Welcome, ${GLOBAL_STATE.currentUser.name}</p>
                        </div>
                        <div class="flex gap-4">
                            <button id="agent-view-leads-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg">Leads</button>
                            <button id="agent-view-calendar-btn" class="bg-white border px-6 py-2 rounded-lg">Calendar</button>
                            <button onclick="logout()" class="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg">Sign Out</button>
                        </div>
                    </header>

                    <div id="agent-leads-section">
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl border shadow-sm">
                                <p class="text-sm text-gray-500">Total Leads</p>
                                <p id="agent-total-leads" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl border shadow-sm">
                                <p class="text-sm text-gray-500">Active Leads</p>
                                <p id="agent-active-leads" class="text-3xl font-bold text-indigo-900">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl border shadow-sm">
                                <p class="text-sm text-gray-500">Appointments</p>
                                <p id="agent-total-appointments" class="text-3xl font-bold">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl border shadow-sm">
                                <p class="text-sm text-gray-500">Closed</p>
                                <p id="agent-closed-deals" class="text-3xl font-bold">0</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-2xl shadow-sm border">
                            <div class="px-6 py-4 bg-gray-50 border-b flex justify-between items-center">
                                <h3 class="font-bold">My Leads</h3>
                                <div class="flex gap-2">
                                    <button id="filter-active-btn" class="px-4 py-1.5 rounded-lg bg-indigo-600 text-white text-sm">Active</button>
                                    <button id="filter-all-btn" class="px-4 py-1.5 rounded-lg border text-sm">All</button>
                                </div>
                            </div>
                            <div id="agent-leads-container"></div>
                        </div>
                    </div>

                    <div id="agent-calendar-section" class="hidden mt-8">
                        <div class="bg-white rounded-2xl shadow-sm border p-6">
                            <div class="flex justify-between items-center mb-6">
                                <div class="flex items-center gap-4">
                                    <h2 id="agent-calendar-title" class="text-xl font-bold"></h2>
                                    <div class="flex gap-2">
                                        <button onclick="changeCalendarMonth(-1, 'agent')" class="p-2 hover:bg-gray-100 rounded">←</button>
                                        <button onclick="changeCalendarMonth(1, 'agent')" class="p-2 hover:bg-gray-100 rounded">→</button>
                                    </div>
                                </div>
                                <span class="text-sm text-gray-600">My Appointments</span>
                            </div>
                            <div id="agent-calendar-grid" class="calendar-grid"></div>
                        </div>
                    </div>
                </div>

                <div id="booking-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[110] p-4">
                    <div class="bg-white rounded-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-6">Book Appointment</h2>
                        <p class="mb-6">For <span id="booking-lead-name" class="font-bold text-indigo-600"></span></p>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Date</label>
                                <input type="date" id="booking-date" min="${new Date().toISOString().split('T')[0]}" class="w-full border rounded-lg p-3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Time</label>
                                <select id="booking-time" class="w-full border rounded-lg p-3">
                                    <option value="">Select time</option>
                                    ${Array.from({length: 9}, (_, i) => {
                                        const hour = 9 + i;
                                        return `<option value="${hour.toString().padStart(2,'0')}:00">${hour}:00 ${hour < 12 ? 'AM' : 'PM'}</option>`;
                                    }).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Notes (optional)</label>
                            <textarea id="booking-notes" rows="3" class="w-full border rounded-lg p-3"></textarea>
                        </div>

                        <div class="flex gap-4">
                            <button id="cancel-booking" class="flex-1 py-3 border rounded-lg hover:bg-gray-50">Cancel</button>
                            <button id="confirm-booking" class="flex-1 py-3 bg-indigo-600 text-white rounded-lg font-bold hover:bg-indigo-700">Confirm</button>
                        </div>
                    </div>
                </div>

                ${getSharedModalsHTML()}`;
        }

        function setupAgentHandlers() {
            const activeBtn = document.getElementById('filter-active-btn');
            const allBtn = document.getElementById('filter-all-btn');

            if (activeBtn) {
                activeBtn.addEventListener('click', () => {
                    GLOBAL_STATE.agentLeadFilter = 'active';
                    activeBtn.classList.add('bg-indigo-600', 'text-white');
                    activeBtn.classList.remove('border');
                    allBtn.classList.remove('bg-indigo-600', 'text-white');
                    allBtn.classList.add('border');
                    renderAgentLeads();
                });
            }

            if (allBtn) {
                allBtn.addEventListener('click', () => {
                    GLOBAL_STATE.agentLeadFilter = 'all';
                    allBtn.classList.add('bg-indigo-600', 'text-white');
                    allBtn.classList.remove('border');
                    activeBtn.classList.remove('bg-indigo-600', 'text-white');
                    activeBtn.classList.add('border');
                    renderAgentLeads();
                });
            }

            document.getElementById('agent-view-leads-btn')?.addEventListener('click', () => {
                document.getElementById('agent-leads-section').classList.remove('hidden');
                document.getElementById('agent-calendar-section').classList.add('hidden');
            });

            document.getElementById('agent-view-calendar-btn')?.addEventListener('click', () => {
                document.getElementById('agent-leads-section').classList.add('hidden');
                document.getElementById('agent-calendar-section').classList.remove('hidden');
                renderAgentCalendar();
            });

            const confirmBtn = document.getElementById('confirm-booking');
            const cancelBtn = document.getElementById('cancel-booking');

            if (confirmBtn) {
                confirmBtn.onclick = confirmBooking;
            }

            if (cancelBtn) {
                cancelBtn.onclick = closeBookingModal;
            }
        }

        function renderAgentUI() {
            const myLeads = GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentUser.id] || [];
            const total = myLeads.length;
            const active = myLeads.filter(l => l.disposition === 'New Lead' || l.disposition === 'Call Back Scheduled').length;
            const appts = GLOBAL_STATE.appointments.filter(a => a.agentId === GLOBAL_STATE.currentUser.id).length;
            const closed = myLeads.filter(l => l.disposition === 'Closed').length;

            document.getElementById('agent-total-leads').textContent = total;
            document.getElementById('agent-active-leads').textContent = active;
            document.getElementById('agent-total-appointments').textContent = appts;
            document.getElementById('agent-closed-deals').textContent = closed;

            renderAgentLeads();
        }

        function renderAgentLeads() {
            const container = document.getElementById('agent-leads-container');
            if (!container) return;

            const filter = GLOBAL_STATE.agentLeadFilter || 'active';
            const allLeads = GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentUser.id] || [];
            const filteredLeads = filter === 'active'
                ? allLeads.filter(l => l.disposition === 'New Lead' || l.disposition === 'Call Back Scheduled')
                : allLeads;

            if (filteredLeads.length === 0) {
                container.innerHTML = `
                    <div class="p-12 text-center text-gray-500">
                        No ${filter === 'active' ? 'active' : ''} leads yet
                    </div>`;
                return;
            }

            let html = `
                <table class="w-full">
                    <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                        <tr>
                            <th class="px-6 py-3 text-left">Name</th>
                            <th class="px-6 py-3 text-left">Phone</th>
                            <th class="px-6 py-3 text-left">Status</th>
                            <th class="px-6 py-3 text-center">Update Status</th>
                            <th class="px-6 py-3 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y">
            `;

            filteredLeads.forEach(lead => {
                const statusClass = getStatusClass(lead.disposition);
                html += `
                    <tr>
                        <td class="px-6 py-4 font-medium">${lead.name || '—'}</td>
                        <td class="px-6 py-4">${lead.phone || '—'}</td>
                        <td class="px-6 py-4">
                            <span class="appointment-badge ${statusClass}">${lead.disposition}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <select onchange="updateLeadDisposition('${lead.id}', this.value)" 
                                    class="border rounded px-2 py-1 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                <option value="New Lead" ${lead.disposition === 'New Lead' ? 'selected' : ''}>New Lead</option>
                                <option value="Called - No Answer" ${lead.disposition === 'Called - No Answer' ? 'selected' : ''}>No Answer</option>
                                <option value="Called - Voicemail" ${lead.disposition === 'Called - Voicemail' ? 'selected' : ''}>Voicemail</option>
                                <option value="Call Back Scheduled" ${lead.disposition === 'Call Back Scheduled' ? 'selected' : ''}>Call Back</option>
                                <option value="Appointment Booked" ${lead.disposition === 'Appointment Booked' ? 'selected' : ''}>Appointment Set</option>
                                <option value="Closed" ${lead.disposition === 'Closed' ? 'selected' : ''}>Closed</option>
                            </select>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <button onclick="bookAppointmentForLead('${lead.id}')" 
                                    class="bg-indigo-100 text-indigo-700 px-4 py-1.5 rounded-lg text-sm hover:bg-indigo-200">
                                Book Appointment
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }

        function getStatusClass(disposition) {
            const map = {
                'New Lead': 'status-new',
                'Called - No Answer': 'status-noanswer',
                'Called - Voicemail': 'status-voicemail',
                'Call Back Scheduled': 'status-callback',
                'Appointment Booked': 'status-appointment',
                'Closed': 'status-closed'
            };
            return map[disposition] || 'status-new';
        }

        function updateLeadDisposition(leadId, newStatus) {
            const leads = GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentUser.id] || [];
            const lead = leads.find(l => l.id === leadId);
            if (lead) {
                lead.disposition = newStatus;
                renderAgentUI();
            }
        }

        function bookAppointmentForLead(leadId) {
            const leads = GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentUser.id] || [];
            const lead = leads.find(l => l.id === leadId);
            
            if (!lead) {
                alert("Lead not found");
                return;
            }

            document.getElementById('booking-lead-name').textContent = lead.name || 'Unknown';
            GLOBAL_STATE.currentBookingLead = lead;

            document.getElementById('booking-date').value = '';
            document.getElementById('booking-time').value = '';
            document.getElementById('booking-notes').value = '';

            const modal = document.getElementById('booking-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function confirmBooking() {
            if (!GLOBAL_STATE.currentBookingLead) return alert("No lead selected");

            const date = document.getElementById('booking-date').value;
            const time = document.getElementById('booking-time').value;
            const notes = document.getElementById('booking-notes').value.trim();

            if (!date || !time) {
                alert("Please select both date and time");
                return;
            }

            const appt = {
                id: 'appt_' + Date.now(),
                agentId: GLOBAL_STATE.currentUser.id,
                agentName: GLOBAL_STATE.currentUser.name,
                leadId: GLOBAL_STATE.currentBookingLead.id,
                leadName: GLOBAL_STATE.currentBookingLead.name,
                leadEmail: GLOBAL_STATE.currentBookingLead.email || '',
                leadPhone: GLOBAL_STATE.currentBookingLead.phone || '',
                leadAddress: GLOBAL_STATE.currentBookingLead.address || '',
                date,
                time,
                notes
            };

            GLOBAL_STATE.appointments.push(appt);
            GLOBAL_STATE.currentBookingLead.disposition = 'Appointment Booked';

            // Close modal FIRST
            closeBookingModal();
            
            // Then refresh UI
            renderAgentUI();

            // Show success message
            alert(`Appointment booked for ${appt.date} at ${appt.time}`);
        }

        function closeBookingModal() {
            const modal = document.getElementById('booking-modal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            GLOBAL_STATE.currentBookingLead = null;
            
            // Clear form fields
            document.getElementById('booking-date').value = '';
            document.getElementById('booking-time').value = '';
            document.getElementById('booking-notes').value = '';
        }

        // ════════════════════════════════════════════════
        // RECEPTIONIST DASHBOARD
        // ════════════════════════════════════════════════
        function showReceptionistDashboard() {
            document.getElementById('receptionist-login-screen').style.display = 'none';
            const app = document.getElementById('receptionist-app');
            app.classList.remove('hidden');
            app.innerHTML = getReceptionistHTML();
            renderReceptionistAppointments();
        }

        function getReceptionistHTML() {
            return `
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <header class="flex justify-between items-center mb-8">
                        <div>
                            <h1 class="text-3xl font-extrabold text-gray-900">Receptionist Console</h1>
                            <p class="text-gray-500">All Bookings Overview</p>
                        </div>
                        <div class="flex items-center gap-4">
                            <div class="bg-teal-50 border border-teal-200 rounded-lg px-4 py-2">
                                <div class="text-xs text-teal-600 font-medium">Logged in as</div>
                                <div class="text-sm font-bold text-teal-900">${GLOBAL_STATE.currentUser.email}</div>
                            </div>
                            <button onclick="logout()" class="bg-gray-200 hover:bg-gray-300 px-6 py-2 rounded-lg">Sign Out</button>
                        </div>
                    </header>

                    <div class="bg-white rounded-2xl shadow-sm border overflow-hidden">
                        <div class="px-6 py-4 bg-gray-50 border-b">
                            <h3 class="font-bold text-lg">All Appointments</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full min-w-max">
                                <thead class="bg-gray-50 text-xs uppercase text-gray-500">
                                    <tr>
                                        <th class="px-6 py-3 text-left">Date & Time</th>
                                        <th class="px-6 py-3 text-left">Client</th>
                                        <th class="px-6 py-3 text-left">Contact</th>
                                        <th class="px-6 py-3 text-left">Address</th>
                                        <th class="px-6 py-3 text-left">Agent</th>
                                        <th class="px-6 py-3 text-left">Notes</th>
                                        <th class="px-6 py-3 text-right">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="receptionist-appointments-body" class="divide-y"></tbody>
                            </table>
                        </div>
                        <div id="receptionist-empty" class="p-12 text-center text-gray-500 hidden">
                            No appointments scheduled yet.
                        </div>
                    </div>

                    <!-- Credentials Card -->
                    <div class="mt-8 bg-gradient-to-br from-teal-50 to-teal-100 rounded-2xl shadow-sm border border-teal-200 p-6">
                        <div class="flex items-start gap-4">
                            <div class="w-12 h-12 bg-teal-600 rounded-full flex items-center justify-center flex-shrink-0">
                                <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/></svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-bold text-teal-900 mb-2">Receptionist Login Credentials</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="bg-white rounded-lg p-4 border border-teal-200">
                                        <div class="text-xs text-teal-600 font-medium mb-1">Email</div>
                                        <div class="font-mono text-sm font-bold text-gray-900">${GLOBAL_STATE.receptionistCredentials.email}</div>
                                    </div>
                                    <div class="bg-white rounded-lg p-4 border border-teal-200">
                                        <div class="text-xs text-teal-600 font-medium mb-1">Password</div>
                                        <div class="font-mono text-sm font-bold text-gray-900">${GLOBAL_STATE.receptionistCredentials.pass}</div>
                                    </div>
                                </div>
                                <p class="text-xs text-teal-700 mt-3">💡 Share these credentials with your reception staff to access the booking system</p>
                            </div>
                        </div>
                    </div>
                </div>
                ${getSharedModalsHTML()}`;
        }

        function renderReceptionistAppointments() {
            const tbody = document.getElementById('receptionist-appointments-body');
            const empty = document.getElementById('receptionist-empty');
            
            tbody.innerHTML = '';
            if (GLOBAL_STATE.appointments.length === 0) {
                empty.classList.remove('hidden');
                return;
            }
            empty.classList.add('hidden');

            GLOBAL_STATE.appointments.forEach(appt => {
                const agent = GLOBAL_STATE.registeredAgents.find(a => a.id === appt.agentId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4">${appt.date} ${appt.time}</td>
                    <td class="px-6 py-4 font-medium">${appt.leadName}</td>
                    <td class="px-6 py-4">${appt.leadEmail || ''} ${appt.leadPhone ? '/ ' + appt.leadPhone : ''}</td>
                    <td class="px-6 py-4">${appt.leadAddress || '—'}</td>
                    <td class="px-6 py-4">${agent ? agent.name : 'Unknown'}</td>
                    <td class="px-6 py-4">${appt.notes || '—'}</td>
                    <td class="px-6 py-4 text-right">
                        <button onclick="showAppointmentDetails('${appt.id}')" class="text-indigo-600 hover:text-indigo-800">View Details</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ════════════════════════════════════════════════
        // SHARED MODALS
        // ════════════════════════════════════════════════
        function getSharedModalsHTML() {
            return `
                <div id="appointment-details-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[120] p-4">
                    <div class="bg-white rounded-2xl max-w-lg w-full p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Appointment Details</h2>
                            <button id="close-appointment-details" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div id="appointment-details-content" class="space-y-4"></div>
                        <button id="delete-appointment-btn" class="mt-6 w-full bg-red-100 text-red-700 py-3 rounded-lg hover:bg-red-200 hidden">Delete Appointment</button>
                    </div>
                </div>

                <div id="admin-upload-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[110] p-4">
                    <div class="bg-white rounded-2xl max-w-md w-full p-8">
                        <h2 class="text-xl font-bold mb-2">Upload Leads</h2>
                        <p class="text-sm text-gray-500 mb-6">For <span id="admin-target-agent-name" class="font-bold text-indigo-600"></span></p>
                        <div id="admin-drop-zone" class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-500">
                            <input type="file" id="admin-lead-file-input" class="hidden" accept=".csv,.json">
                            <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            <p>Click or drag CSV / JSON file</p>
                        </div>
                        <div id="admin-upload-status" class="mt-4 p-3 rounded text-center hidden"></div>
                        <button id="admin-close-upload" class="mt-6 w-full py-2 border rounded-lg hover:bg-gray-50">Close</button>
                    </div>
                </div>

                <div id="agent-progress-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[110] p-4">
                    <div class="bg-white rounded-2xl max-w-md w-full p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold">Agent Progress: <span id="progress-agent-name"></span></h2>
                            <button id="close-progress-modal" class="text-gray-500 hover:text-gray-700">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                            </button>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between"><span>Total Leads:</span><span id="progress-total-leads" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Leads Left (New):</span><span id="progress-leads-left" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Disposed Leads:</span><span id="progress-disposed" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Bookings:</span><span id="progress-bookings" class="font-bold">0</span></div>
                            <div class="flex justify-between"><span>Closed Deals:</span><span id="progress-closed" class="font-bold">0</span></div>
                        </div>
                    </div>
                </div>`;
        }

        function showAppointmentDetails(id) {
            const appt = GLOBAL_STATE.appointments.find(a => a.id === id);
            if (!appt) return;

            const content = document.getElementById('appointment-details-content');
            content.innerHTML = `
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <div>
                            <div class="text-sm text-gray-500">Date & Time</div>
                            <div class="font-medium">${appt.date} at ${appt.time}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-sm text-gray-500">Agent</div>
                            <div class="font-medium">${appt.agentName}</div>
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Client</div>
                        <div class="font-medium">${appt.leadName}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-sm text-gray-500">Email</div>
                            <div>${appt.leadEmail || '—'}</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">Phone</div>
                            <div>${appt.leadPhone || '—'}</div>
                        </div>
                    </div>
                    <div>
                        <div class="text-sm text-gray-500">Address</div>
                        <div>${appt.leadAddress || 'Not provided'}</div>
                    </div>
                    ${appt.notes ? `
                    <div>
                        <div class="text-sm text-gray-500">Notes</div>
                        <div class="mt-1 p-3 bg-gray-50 rounded border">${appt.notes}</div>
                    </div>` : ''}
                </div>
            `;

            const modal = document.getElementById('appointment-details-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';

            const deleteBtn = document.getElementById('delete-appointment-btn');
            const closeBtn = document.getElementById('close-appointment-details');
            
            // Remove old event listeners by cloning
            const newCloseBtn = closeBtn.cloneNode(true);
            closeBtn.parentNode.replaceChild(newCloseBtn, closeBtn);
            
            const newDeleteBtn = deleteBtn.cloneNode(true);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);
            
            // Add fresh event listeners
            newCloseBtn.onclick = () => {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            };
            
            // Click outside to close
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                }
            };
            
            if (GLOBAL_STATE.userType === 'receptionist') {
                newDeleteBtn.classList.add('hidden');
            } else {
                newDeleteBtn.classList.remove('hidden');
                newDeleteBtn.onclick = () => {
                    if (confirm("Delete this appointment?")) {
                        GLOBAL_STATE.appointments = GLOBAL_STATE.appointments.filter(a => a.id !== id);
                        const lead = Object.values(GLOBAL_STATE.agentLeads).flat().find(l => l.id === appt.leadId);
                        if (lead) lead.disposition = "Call Back Scheduled";
                        modal.classList.add('hidden');
                        modal.style.display = 'none';
                        if (GLOBAL_STATE.userType === 'admin') renderAdminCalendar();
                        if (GLOBAL_STATE.userType === 'agent') { renderAgentCalendar(); renderAgentUI(); }
                    }
                };
            }
        }

        // ════════════════════════════════════════════════
        // CALENDAR FUNCTIONS
        // ════════════════════════════════════════════════
        function changeCalendarMonth(delta, portal) {
            GLOBAL_STATE.calendarView = new Date(
                GLOBAL_STATE.calendarView.getFullYear(),
                GLOBAL_STATE.calendarView.getMonth() + delta,
                1
            );
            if (portal === 'admin') renderAdminCalendar();
            if (portal === 'agent') renderAgentCalendar();
        }

        function renderAdminCalendar() {
            const title = document.getElementById('admin-calendar-title');
            const grid = document.getElementById('admin-calendar-grid');
            const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            title.textContent = `${months[GLOBAL_STATE.calendarView.getMonth()]} ${GLOBAL_STATE.calendarView.getFullYear()}`;

            const year = GLOBAL_STATE.calendarView.getFullYear();
            const month = GLOBAL_STATE.calendarView.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
                html += `<div class="text-center font-bold text-xs py-2 bg-gray-100 border">${d}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="border bg-gray-50"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const dayAppts = GLOBAL_STATE.appointments.filter(a => a.date === dateStr);
                let badgeHtml = '';
                dayAppts.forEach(appt => {
                    badgeHtml += `<div class="appointment-badge bg-indigo-100 text-indigo-800" onclick="showAppointmentDetails('${appt.id}')">${appt.time} - ${appt.leadName}</div>`;
                });
                html += `
                    <div class="border p-2 min-h-[100px] hover:bg-gray-50">
                        <div class="text-right text-sm font-medium mb-1">${day}</div>
                        ${badgeHtml}
                    </div>`;
            }
            grid.innerHTML = html;
        }

        function renderAgentCalendar() {
            const title = document.getElementById('agent-calendar-title');
            const grid = document.getElementById('agent-calendar-grid');
            const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
            title.textContent = `${months[GLOBAL_STATE.calendarView.getMonth()]} ${GLOBAL_STATE.calendarView.getFullYear()}`;

            const year = GLOBAL_STATE.calendarView.getFullYear();
            const month = GLOBAL_STATE.calendarView.getMonth();
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            let html = '';
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
                html += `<div class="text-center font-bold text-xs py-2 bg-gray-100 border">${d}</div>`;
            });

            for (let i = 0; i < firstDay; i++) {
                html += '<div class="border bg-gray-50"></div>';
            }

            const myAppts = GLOBAL_STATE.appointments.filter(a => a.agentId === GLOBAL_STATE.currentUser.id);

            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
                const dayAppts = myAppts.filter(a => a.date === dateStr);
                let badgeHtml = '';
                dayAppts.forEach(appt => {
                    badgeHtml += `<div class="appointment-badge bg-green-100 text-green-800" onclick="showAppointmentDetails('${appt.id}')">${appt.time} - ${appt.leadName}</div>`;
                });
                html += `
                    <div class="border p-2 min-h-[100px] hover:bg-gray-50">
                        <div class="text-right text-sm font-medium mb-1">${day}</div>
                        ${badgeHtml}
                    </div>`;
            }
            grid.innerHTML = html;
        }
    </script>
</body>
</html>
