<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NODE CRM </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
       <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script type="text/javascript">
        (function() {
            emailjs.init("RTPjX2b83Z5jRwiKL");
        })();
    </script>
    <style>
        #admin-login-screen, #agent-login-screen {
            background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);
        }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); }
        .calendar-day { min-height: 100px; position: relative; }
        .appointment-badge { font-size: 0.65rem; line-height: 1.2; margin-top: 2px; padding: 2px 4px; border-radius: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; }
        .disposition-badge { transition: all 0.2s; }
        .status-new { background-color: #DBEAFE; color: #1E40AF; }
        .status-noanswer { background-color: #FEF3C7; color: #92400E; }
        .status-voicemail { background-color: #F3E8FF; color: #6B21A8; }
        .status-callback { background-color: #E0F2FE; color: #075985; }
        .status-appointment { background-color: #D1FAE5; color: #065F46; }
        .status-closed { background-color: #FEE2E2; color: #991B1B; }
        .time-slot { cursor: pointer; transition: all 0.2s; }
        .time-slot:hover { background-color: #EEF2FF; }
        .time-slot.selected { background-color: #4F46E5; color: white; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="portal-selection" class="fixed inset-0 z-[100] flex items-center justify-center p-4" style="background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%);">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-900 mb-2">NODE CRM </h1>
                <p class="text-gray-500">Choose your portal to continue</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <button onclick="selectPortal('admin')" class="group p-8 border-2 border-gray-200 rounded-xl hover:border-red-500 hover:bg-red-50 transition">
                    <div class="w-16 h-16 bg-red-100 text-red-600 rounded-full mx-auto mb-4 flex items-center justify-center group-hover:bg-red-600 group-hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Admin Console</h3>
                    <p class="text-sm text-gray-600">Manage agents, upload leads, and view master calendar</p>
                </button>
                <button onclick="selectPortal('agent')" class="group p-8 border-2 border-gray-200 rounded-xl hover:border-indigo-500 hover:bg-indigo-50 transition">
                    <div class="w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full mx-auto mb-4 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 mb-2">Agent Portal</h3>
                    <p class="text-sm text-gray-600">Manage leads, book appointments, and track progress</p>
                </button>
            </div>
        </div>
    </div>

    <div id="admin-login-screen" class="fixed inset-0 z-[100] hidden p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <button onclick="backToPortalSelection()" class="mb-4 text-gray-500 hover:text-gray-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back
            </button>
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-red-100 text-red-600 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Admin Login</h2>
                <p class="text-gray-500">NODE CRM  </p>
            </div>
            <form id="admin-login-form" class="space-y-6">
                <div><label class="block text-sm font-medium text-gray-700">Admin Email</label>
                    <input type="email" id="admin-email" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-red-500" placeholder="admin@tac.co.za" value="admin@tac.co.za"></div>
                <div><label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="admin-pass" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-red-500" placeholder="••••••••" value="TacCRMS123!"></div>
                <button type="submit" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-lg transition duration-200">Authorize Access</button>
            </form>
            <div id="admin-login-error" class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 hidden text-center">Invalid Admin Credentials.</div>
        </div>
    </div>

    <div id="agent-login-screen" class="fixed inset-0 z-[100] hidden p-4" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8">
            <button onclick="backToPortalSelection()" class="mb-4 text-gray-500 hover:text-gray-700 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back
            </button>
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-indigo-100 text-indigo-600 rounded-full mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900">Agent Portal</h2>
                <p class="text-gray-500">Sign in with credentials from Admin</p>
            </div>
            <form id="agent-login-form" class="space-y-6">
                <div><label class="block text-sm font-medium text-gray-700">Email Address</label>
                    <input type="email" id="agent-email" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="agent@company.com"></div>
                <div><label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="agent-pass" required class="mt-1 block w-full border border-gray-300 rounded-lg p-3 outline-none focus:ring-2 focus:ring-indigo-500" placeholder="••••••••"></div>
                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg transition duration-200">Login to Dashboard</button>
            </form>
            <div id="agent-login-error" class="mt-4 p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 hidden text-center">Invalid credentials. Please contact your administrator.</div>
        </div>
    </div>

    <div id="admin-app" class="hidden"></div>
    <div id="agent-app" class="hidden"></div>

    <script>
        const GLOBAL_STATE = {
            adminCredentials: { email: 'admin@tac.co.za', pass: 'TacCRMS123!' },
            currentUser: null, userType: null, registeredAgents: [], agentLeads: {}, 
            appointments: [], 
            dispositions: ["New Lead", "Called - No Answer", "Called - Voicemail", "Call Back Scheduled", "Appointment Booked", "Closed"],
            currentDate: new Date(), 
            currentTargetAgentId: null,
            currentBookingLead: null,
            calendarView: new Date(),
            agentLeadFilter: 'active' // 'active' or 'all'
        };

        function selectPortal(type) {
            document.getElementById('portal-selection').classList.add('hidden');
            const screen = type === 'admin' ? 'admin-login-screen' : 'agent-login-screen';
            const el = document.getElementById(screen);
            el.classList.remove('hidden');
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.justifyContent = 'center';
        }

        function backToPortalSelection() {
            document.getElementById('portal-selection').classList.remove('hidden');
            const adminScreen = document.getElementById('admin-login-screen');
            const agentScreen = document.getElementById('agent-login-screen');
            adminScreen.classList.add('hidden');
            adminScreen.style.display = 'none';
            agentScreen.classList.add('hidden');
            agentScreen.style.display = 'none';
        }

        function logout() {
            GLOBAL_STATE.currentUser = null;
            GLOBAL_STATE.userType = null;
            document.getElementById('admin-app').classList.add('hidden');
            document.getElementById('agent-app').classList.add('hidden');
            document.getElementById('portal-selection').classList.remove('hidden');
        }

        window.onload = function() {
            document.getElementById('admin-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('admin-email').value;
                const pass = document.getElementById('admin-pass').value;
                if (email === GLOBAL_STATE.adminCredentials.email && pass === GLOBAL_STATE.adminCredentials.pass) {
                    GLOBAL_STATE.currentUser = { email, name: 'Admin' };
                    GLOBAL_STATE.userType = 'admin';
                    showAdminDashboard();
                } else {
                    const err = document.getElementById('admin-login-error');
                    err.classList.remove('hidden');
                    setTimeout(() => err.classList.add('hidden'), 3000);
                }
            });

            document.getElementById('agent-login-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const email = document.getElementById('agent-email').value;
                const pass = document.getElementById('agent-pass').value;
                const agent = GLOBAL_STATE.registeredAgents.find(a => a.email === email && a.password === pass);
                if (agent) {
                    GLOBAL_STATE.currentUser = agent;
                    GLOBAL_STATE.userType = 'agent';
                    showAgentDashboard();
                } else {
                    const err = document.getElementById('agent-login-error');
                    err.classList.remove('hidden');
                    setTimeout(() => err.classList.add('hidden'), 3000);
                }
            });
        };

        function showAdminDashboard() {
            const loginScreen = document.getElementById('admin-login-screen');
            loginScreen.classList.add('hidden');
            loginScreen.style.display = 'none';
            const app = document.getElementById('admin-app');
            app.classList.remove('hidden');
            app.innerHTML = getAdminHTML();
            setupAdminHandlers();
            renderAdminAgents();
        }

        function getAdminHTML() {
            return `
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <header class="flex justify-between items-center mb-8">
                        <div><h1 class="text-3xl font-extrabold text-gray-900">NODE CRM</h1><p class="text-gray-500">Global Overview & Agent Management</p></div>
                        <div class="flex gap-4">
                            <button id="admin-view-agents-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold">Agents</button>
                            <button id="admin-view-calendar-btn" class="bg-white text-gray-700 border border-gray-200 px-6 py-2 rounded-lg font-semibold">Master Calendar</button>
                            <button onclick="logout()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-semibold">Sign Out</button>
                        </div>
                    </header>
                    <div id="admin-agent-section" class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                        <div class="lg:col-span-1">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
                                <h3 class="text-lg font-bold text-gray-800 mb-6">Create New Agent</h3>
                                <form id="admin-create-agent-form" class="space-y-4">
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase">Agent Name</label>
                                        <input type="text" id="admin-new-agent-name" required class="mt-1 block w-full border border-gray-200 rounded-lg p-2.5" placeholder="John Doe"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase">Login Email</label>
                                        <input type="email" id="admin-new-agent-email" required class="mt-1 block w-full border border-gray-200 rounded-lg p-2.5" placeholder="john@tac.co.za"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 uppercase">Default Password</label>
                                        <input type="text" id="admin-new-agent-pass" required class="mt-1 block w-full border border-gray-200 rounded-lg p-2.5" placeholder="Agent2024!"></div>
                                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-lg">Register Agent</button>
                                </form>
                            </div>
                        </div>
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-2xl shadow-sm border border-gray-200">
                                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                    <h3 class="font-bold text-gray-800">Active Agents</h3>
                                    <span id="admin-agent-count" class="bg-indigo-100 text-indigo-700 text-xs font-bold px-2.5 py-1 rounded-full">0 Agents</span>
                                </div>
                                <table class="w-full text-left">
                                    <thead class="bg-gray-50 text-gray-400 text-xs uppercase font-bold">
                                        <tr>
                                            <th class="px-6 py-3">Agent</th>
                                            <th class="px-6 py-3">Credentials</th>
                                            <th class="px-6 py-3 text-center">Leads</th>
                                            <th class="px-6 py-3 text-center">Appointments</th>
                                            <th class="px-6 py-3 text-center">Closed</th>
                                            <th class="px-6 py-3 text-right">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-agent-list-body" class="divide-y divide-gray-100"></tbody>
                                </table>
                                <div id="admin-empty-state" class="p-12 text-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                    <p class="text-gray-400 font-medium">No agents registered yet.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div id="admin-calendar-section" class="hidden mt-8">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-4">
                                    <h2 id="admin-calendar-title" class="text-xl font-bold text-gray-900"></h2>
                                    <div class="flex gap-1">
                                        <button onclick="changeAdminMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                                        <button onclick="changeAdminMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 bg-indigo-500 rounded-full"></span>
                                    <span class="text-xs text-gray-500 font-medium">All Appointments</span>
                                </div>
                            </div>
                            <div id="admin-calendar-grid"></div>
                        </div>
                    </div>
                </div>
                ${getModalsHTML()}`;
        }

        function getModalsHTML() {
            return `
                <div id="admin-upload-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[110] px-4">
                    <div class="bg-white rounded-2xl max-w-md w-full p-8">
                        <h2 class="text-xl font-bold mb-2">Upload Leads</h2>
                        <p class="text-sm text-gray-500 mb-6">For <span id="admin-target-agent-name" class="font-bold text-indigo-600"></span></p>
                        <div class="border-2 border-dashed border-gray-200 rounded-xl p-8 text-center cursor-pointer" id="admin-drop-zone">
                            <input type="file" id="admin-lead-file-input" class="hidden" accept=".csv,.tsv,.txt,.json">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 mx-auto text-gray-400 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" /></svg>
                            <p class="text-sm font-medium text-gray-700">Click to upload CSV/TSV/JSON</p>
                            <p class="text-xs text-gray-400 mt-1">Tab or comma delimited files accepted</p>
                        </div>
                        <div id="admin-upload-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>
                        <button id="admin-close-upload" class="mt-6 w-full px-4 py-2.5 text-gray-600 font-medium hover:bg-gray-50 rounded-lg">Cancel</button>
                    </div>
                </div>
                
                <div id="admin-agent-details-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[110] px-4">
                    <div class="bg-white rounded-2xl max-w-4xl w-full p-8 max-h-[90vh] overflow-y-auto">
                        <div class="flex justify-between items-center mb-6">
                            <div>
                                <h2 class="text-2xl font-bold text-gray-900" id="agent-details-name"></h2>
                                <p class="text-sm text-gray-500" id="agent-details-email"></p>
                            </div>
                            <button id="admin-close-agent-details" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <p class="text-sm text-blue-600 font-medium">Total Leads</p>
                                <p class="text-3xl font-bold text-blue-700 mt-1" id="agent-details-total"></p>
                            </div>
                            <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                                <p class="text-sm text-green-600 font-medium">Appointments</p>
                                <p class="text-3xl font-bold text-green-700 mt-1" id="agent-details-appointments"></p>
                            </div>
                            <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                                <p class="text-sm text-purple-600 font-medium">Closed Deals</p>
                                <p class="text-3xl font-bold text-purple-700 mt-1" id="agent-details-closed"></p>
                            </div>
                        </div>
                        
                        <div class="border border-gray-200 rounded-lg overflow-hidden">
                            <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
                                <h3 class="font-bold text-gray-800">All Leads</h3>
                            </div>
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gray-50 text-gray-400 text-xs uppercase font-bold">
                                        <tr>
                                            <th class="px-4 py-3 text-left">Name</th>
                                            <th class="px-4 py-3 text-left">Contact</th>
                                            <th class="px-4 py-3 text-left">Company</th>
                                            <th class="px-4 py-3 text-left">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="agent-details-leads-body" class="divide-y divide-gray-100"></tbody>
                                </table>
                            </div>
                            <div id="agent-details-empty" class="p-8 text-center hidden">
                                <p class="text-gray-400">No leads assigned yet</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="appointment-details-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[120] px-4">
                    <div class="bg-white rounded-2xl max-w-lg w-full p-8">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-xl font-bold text-gray-900">Appointment Details</h2>
                            <button id="close-appointment-details" class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                        <div id="appointment-details-content" class="space-y-4"></div>
                        <button id="delete-appointment-btn" class="mt-6 w-full bg-red-100 hover:bg-red-200 text-red-700 font-medium py-3 rounded-lg">Delete Appointment</button>
                    </div>
                </div>`;
        }

        function setupAdminHandlers() {
            document.getElementById('admin-create-agent-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const agent = {
                    id: Date.now().toString(),
                    name: document.getElementById('admin-new-agent-name').value,
                    email: document.getElementById('admin-new-agent-email').value,
                    password: document.getElementById('admin-new-agent-pass').value
                };
                GLOBAL_STATE.registeredAgents.push(agent);
                GLOBAL_STATE.agentLeads[agent.id] = [];
                e.target.reset();
                renderAdminAgents();
            });

            document.getElementById('admin-view-agents-btn').onclick = () => {
                document.getElementById('admin-agent-section').classList.remove('hidden');
                document.getElementById('admin-calendar-section').classList.add('hidden');
            };

            document.getElementById('admin-view-calendar-btn').onclick = () => {
                document.getElementById('admin-agent-section').classList.add('hidden');
                document.getElementById('admin-calendar-section').classList.remove('hidden');
                renderAdminCalendar();
            };

            document.getElementById('admin-close-upload').onclick = () => {
                document.getElementById('admin-upload-modal').classList.add('hidden');
                document.getElementById('admin-upload-modal').style.display = 'none';
            };

            document.getElementById('admin-close-agent-details').onclick = () => {
                document.getElementById('admin-agent-details-modal').classList.add('hidden');
                document.getElementById('admin-agent-details-modal').style.display = 'none';
            };

            document.getElementById('admin-drop-zone').onclick = () => {
                document.getElementById('admin-lead-file-input').click();
            };

            document.getElementById('admin-lead-file-input').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    if (file.name.endsWith('.csv') || file.name.endsWith('.tsv') || file.name.endsWith('.txt')) {
                        Papa.parse(ev.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            dynamicTyping: false,
                            complete: (res) => {
                                const leads = res.data.filter(r => {
                                    const name = r.Name || r.name;
                                    const email = r.Email || r.email;
                                    const phone = r.Phone || r.phone;
                                    return name || email || phone;
                                }).map(r => ({
                                    id: Date.now() + Math.random(), 
                                    name: r.Name || r.name || 'Unknown', 
                                    email: r.Email || r.email || '', 
                                    phone: r.Phone || r.phone || '', 
                                    company: r.Company || r.company || '',
                                    notes: r.Notes || r.notes || '',
                                    disposition: 'New Lead'
                                }));
                                GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentTargetAgentId].push(...leads);
                                showUploadSuccess(leads.length);
                                renderAdminAgents();
                            }
                        });
                    } else {
                        const jsonData = JSON.parse(ev.target.result);
                        const leads = jsonData.map(r => ({
                            id: Date.now() + Math.random(), 
                            name: r.Name || r.name || 'Unknown', 
                            email: r.Email || r.email || '', 
                            phone: r.Phone || r.phone || '', 
                            company: r.Company || r.company || '',
                            notes: r.Notes || r.notes || '',
                            disposition: 'New Lead'
                        }));
                        GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentTargetAgentId].push(...leads);
                        showUploadSuccess(leads.length);
                        renderAdminAgents();
                    }
                };
                reader.readAsText(file);
            };
        }

        function renderAdminAgents() {
            const tbody = document.getElementById('admin-agent-list-body');
            const count = document.getElementById('admin-agent-count');
            const empty = document.getElementById('admin-empty-state');
            
            count.textContent = `${GLOBAL_STATE.registeredAgents.length} Agents`;
            
            if (GLOBAL_STATE.registeredAgents.length === 0) {
                empty.classList.remove('hidden');
                tbody.innerHTML = '';
            } else {
                empty.classList.add('hidden');
                tbody.innerHTML = GLOBAL_STATE.registeredAgents.map(a => {
                    const leads = GLOBAL_STATE.agentLeads[a.id] || [];
                    const agentAppointments = GLOBAL_STATE.appointments.filter(ap => ap.agentId === a.id);
                    const closed = leads.filter(l => l.disposition === 'Closed').length;
                    
                    return `
                    <tr>
                        <td class="px-6 py-4"><div class="font-medium text-gray-900">${a.name}</div></td>
                        <td class="px-6 py-4"><div class="text-sm text-gray-600">${a.email}</div><div class="text-xs text-gray-400">${a.password}</div></td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-blue-100 text-blue-700 font-bold text-sm">${leads.length}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-green-100 text-green-700 font-bold text-sm">${agentAppointments.length}</span>
                        </td>
                        <td class="px-6 py-4 text-center">
                            <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-purple-100 text-purple-700 font-bold text-sm">${closed}</span>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="viewAgentDetails('${a.id}')" class="bg-blue-100 hover:bg-blue-200 text-blue-700 text-sm px-4 py-2 rounded-lg mr-2">View</button>
                            <button onclick="openUploadModal('${a.id}', '${a.name}')" class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm px-4 py-2 rounded-lg">Upload Leads</button>
                            <button onclick="deleteAgent('${a.id}')" class="bg-red-100 hover:bg-red-200 text-red-600 text-sm px-4 py-2 rounded-lg ml-2">Delete</button>
                        </td>
                    </tr>
                `}).join('');
            }
        }

        function openUploadModal(agentId, agentName) {
            GLOBAL_STATE.currentTargetAgentId = agentId;
            document.getElementById('admin-target-agent-name').textContent = agentName;
            const modal = document.getElementById('admin-upload-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function deleteAgent(agentId) {
            if (confirm('Delete this agent and all their leads?')) {
                GLOBAL_STATE.registeredAgents = GLOBAL_STATE.registeredAgents.filter(a => a.id !== agentId);
                delete GLOBAL_STATE.agentLeads[agentId];
                GLOBAL_STATE.appointments = GLOBAL_STATE.appointments.filter(a => a.agentId !== agentId);
                renderAdminAgents();
            }
        }

        function viewAgentDetails(agentId) {
            const agent = GLOBAL_STATE.registeredAgents.find(a => a.id === agentId);
            const leads = GLOBAL_STATE.agentLeads[agentId] || [];
            const agentAppointments = GLOBAL_STATE.appointments.filter(ap => ap.agentId === agentId);
            const closed = leads.filter(l => l.disposition === 'Closed');
            
            document.getElementById('agent-details-name').textContent = agent.name;
            document.getElementById('agent-details-email').textContent = agent.email;
            document.getElementById('agent-details-total').textContent = leads.length;
            document.getElementById('agent-details-appointments').textContent = agentAppointments.length;
            document.getElementById('agent-details-closed').textContent = closed.length;
            
            const tbody = document.getElementById('agent-details-leads-body');
            const empty = document.getElementById('agent-details-empty');
            
            if (leads.length === 0) {
                tbody.innerHTML = '';
                empty.classList.remove('hidden');
            } else {
                empty.classList.add('hidden');
                tbody.innerHTML = leads.map(lead => `
                    <tr>
                        <td class="px-4 py-3">
                            <div class="font-medium text-gray-900">${lead.name}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm text-gray-600">${lead.email}</div>
                            <div class="text-xs text-gray-400">${lead.phone}</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm text-gray-600">${lead.company || 'N/A'}</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="text-xs font-medium px-3 py-1 rounded-full ${getStatusClass(lead.disposition)}">${lead.disposition}</span>
                        </td>
                    </tr>
                `).join('');
            }
            
            const modal = document.getElementById('admin-agent-details-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function showUploadSuccess(count) {
            const status = document.getElementById('admin-upload-status');
            status.className = 'p-3 rounded-lg text-sm bg-green-50 text-green-700 border border-green-200';
            status.textContent = `✓ Successfully imported ${count} leads`;
            status.classList.remove('hidden');
            setTimeout(() => {
                document.getElementById('admin-upload-modal').classList.add('hidden');
                document.getElementById('admin-upload-modal').style.display = 'none';
                status.classList.add('hidden');
            }, 2000);
        }

        function changeAdminMonth(delta) {
            GLOBAL_STATE.calendarView = new Date(GLOBAL_STATE.calendarView.getFullYear(), GLOBAL_STATE.calendarView.getMonth() + delta, 1);
            renderAdminCalendar();
        }

        function renderAdminCalendar() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('admin-calendar-title').textContent = `${months[GLOBAL_STATE.calendarView.getMonth()]} ${GLOBAL_STATE.calendarView.getFullYear()}`;
            
            const firstDay = new Date(GLOBAL_STATE.calendarView.getFullYear(), GLOBAL_STATE.calendarView.getMonth(), 1);
            const lastDay = new Date(GLOBAL_STATE.calendarView.getFullYear(), GLOBAL_STATE.calendarView.getMonth() + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            let html = '<div class="calendar-grid border-l border-t border-gray-100">';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="bg-gray-50 p-2 text-center text-xs font-bold text-gray-400 uppercase border-r border-b border-gray-100">${day}</div>`;
            });
            
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day border-r border-b border-gray-100 bg-gray-50"></div>';
            }
            
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${GLOBAL_STATE.calendarView.getFullYear()}-${String(GLOBAL_STATE.calendarView.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = GLOBAL_STATE.appointments.filter(a => a.date === dateStr);
                
                html += `<div class="calendar-day p-2 border-r border-b border-gray-100 bg-white hover:bg-gray-50">
                    <div class="text-sm font-medium text-gray-700 mb-1">${day}</div>`;
                
                dayAppointments.forEach(apt => {
                    html += `<div class="appointment-badge bg-indigo-100 text-indigo-700" onclick="showAppointmentDetails('${apt.id}')">${apt.time} - ${apt.leadName}</div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            document.getElementById('admin-calendar-grid').innerHTML = html;
        }

        function showAppointmentDetails(appointmentId) {
            const apt = GLOBAL_STATE.appointments.find(a => a.id === appointmentId);
            if (!apt) return;
            
            const content = `
                <div class="bg-indigo-50 p-4 rounded-lg border-l-4 border-indigo-500">
                    <div class="flex items-center gap-2 mb-2">
                        <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span class="font-bold text-indigo-900">${apt.date} at ${apt.time}</span>
                    </div>
                </div>
                <div class="space-y-3">
                    <div>
                        <p class="text-xs font-bold text-gray-500 uppercase">Lead</p>
                        <p class="text-sm text-gray-900">${apt.leadName}</p>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-500 uppercase">Agent</p>
                        <p class="text-sm text-gray-900">${apt.agentName}</p>
                    </div>
                    ${apt.notes ? `<div><p class="text-xs font-bold text-gray-500 uppercase">Notes</p><p class="text-sm text-gray-900">${apt.notes}</p></div>` : ''}
                </div>
            `;
            
            document.getElementById('appointment-details-content').innerHTML = content;
            
            const modal = document.getElementById('appointment-details-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            
            document.getElementById('close-appointment-details').onclick = () => {
                modal.classList.add('hidden');
                modal.style.display = 'none';
            };
            
            document.getElementById('delete-appointment-btn').onclick = () => {
                if (confirm('Delete this appointment?')) {
                    GLOBAL_STATE.appointments = GLOBAL_STATE.appointments.filter(a => a.id !== appointmentId);
                    const lead = Object.values(GLOBAL_STATE.agentLeads).flat().find(l => l.id == apt.leadId);
                    if (lead) lead.disposition = 'Call Back Scheduled';
                    modal.classList.add('hidden');
                    modal.style.display = 'none';
                    renderAdminCalendar();
                    renderAdminAgents();
                }
            };
        }

        function showAgentDashboard() {
            const loginScreen = document.getElementById('agent-login-screen');
            loginScreen.classList.add('hidden');
            loginScreen.style.display = 'none';
            const app = document.getElementById('agent-app');
            app.classList.remove('hidden');
            app.innerHTML = getAgentHTML();
            setupAgentHandlers();
            renderAgentUI();
        }

        function getAgentHTML() {
            return `
                <div class="max-w-7xl mx-auto px-4 py-8">
                    <header class="flex justify-between items-center mb-8">
                        <div><h1 class="text-3xl font-extrabold text-gray-900">Agent Dashboard</h1><p class="text-gray-500">Welcome, ${GLOBAL_STATE.currentUser.name}</p></div>
                        <div class="flex gap-4">
                            <button id="agent-view-leads-btn" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-semibold">Leads</button>
                            <button id="agent-view-calendar-btn" class="bg-white text-gray-700 border border-gray-200 px-6 py-2 rounded-lg font-semibold">Calendar</button>
                            <button onclick="logout()" class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-semibold">Sign Out</button>
                        </div>
                    </header>
                    
                    <div id="agent-leads-section">
                        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <p class="text-sm text-gray-500 font-medium">Total Leads</p>
                                <p id="agent-total-leads" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <p class="text-sm text-gray-500 font-medium">Active Leads</p>
                                <p id="agent-active-leads" class="text-3xl font-bold text-indigo-900 mt-1">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <p class="text-sm text-gray-500 font-medium">Appointments</p>
                                <p id="agent-total-appointments" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                            </div>
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                                <p class="text-sm text-gray-500 font-medium">Closed Deals</p>
                                <p id="agent-closed-deals" class="text-3xl font-bold text-gray-900 mt-1">0</p>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200">
                            <div class="px-6 py-4 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                                <h3 class="font-bold text-gray-800">My Leads</h3>
                                <div class="flex gap-2">
                                    <button id="filter-active-btn" onclick="setLeadFilter('active')" class="px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white">
                                        Active Only
                                    </button>
                                    <button id="filter-all-btn" onclick="setLeadFilter('all')" class="px-4 py-2 text-sm font-medium rounded-lg bg-white text-gray-700 border border-gray-200">
                                        All Leads
                                    </button>
                                </div>
                            </div>
                            <div id="agent-leads-container"></div>
                        </div>
                    </div>
                    
                    <div id="agent-calendar-section" class="hidden">
                        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-6">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-4">
                                    <h2 id="agent-calendar-title" class="text-xl font-bold text-gray-900"></h2>
                                    <div class="flex gap-1">
                                        <button onclick="changeAgentMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg></button>
                                        <button onclick="changeAgentMonth(1)" class="p-2 hover:bg-gray-100 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg></button>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="w-3 h-3 bg-green-500 rounded-full"></span>
                                    <span class="text-xs text-gray-500 font-medium">My Appointments</span>
                                </div>
                            </div>
                            <div id="agent-calendar-grid"></div>
                        </div>
                    </div>
                </div>
                
                <div id="booking-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-[110] px-4">
                    <div class="bg-white rounded-2xl max-w-2xl w-full p-8 max-h-[90vh] overflow-y-auto">
                        <h2 class="text-2xl font-bold mb-2">Book Appointment</h2>
                        <p class="text-sm text-gray-500 mb-6">Schedule appointment for <span id="booking-lead-name" class="font-bold text-indigo-600"></span></p>
                        
                        <div class="grid grid-cols-2 gap-6 mb-6">
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Select Date</label>
                                <input type="date" id="booking-date" class="w-full border border-gray-300 rounded-lg p-3" min="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div>
                                <label class="block text-sm font-bold text-gray-700 mb-2">Select Time</label>
                                <select id="booking-time" class="w-full border border-gray-300 rounded-lg p-3">
                                    <option value="">Choose time...</option>
                                    <option value="09:00">09:00 AM</option>
                                    <option value="10:00">10:00 AM</option>
                                    <option value="11:00">11:00 AM</option>
                                    <option value="12:00">12:00 PM</option>
                                    <option value="13:00">01:00 PM</option>
                                    <option value="14:00">02:00 PM</option>
                                    <option value="15:00">03:00 PM</option>
                                    <option value="16:00">04:00 PM</option>
                                    <option value="17:00">05:00 PM</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="mb-6">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Notes (Optional)</label>
                            <textarea id="booking-notes" class="w-full border border-gray-300 rounded-lg p-3" rows="3" placeholder="Add any notes about this appointment..."></textarea>
                        </div>
                        
                        <div class="flex gap-3">
                            <button id="cancel-booking" class="flex-1 px-4 py-3 text-gray-600 font-medium hover:bg-gray-50 rounded-lg border border-gray-300">Cancel</button>
                            <button id="confirm-booking" class="flex-1 px-4 py-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg">Confirm Appointment</button>
                        </div>
                    </div>
                </div>
                ${getModalsHTML()}`;
        }

        function setupAgentHandlers() {
            document.getElementById('agent-view-leads-btn').onclick = () => {
                document.getElementById('agent-leads-section').classList.remove('hidden');
                document.getElementById('agent-calendar-section').classList.add('hidden');
            };

            document.getElementById('agent-view-calendar-btn').onclick = () => {
                document.getElementById('agent-leads-section').classList.add('hidden');
                document.getElementById('agent-calendar-section').classList.remove('hidden');
                renderAgentCalendar();
            };

            document.getElementById('cancel-booking').onclick = () => {
                document.getElementById('booking-modal').classList.add('hidden');
                document.getElementById('booking-modal').style.display = 'none';
            };

            document.getElementById('confirm-booking').onclick = () => {
                const date = document.getElementById('booking-date').value;
                const time = document.getElementById('booking-time').value;
                const notes = document.getElementById('booking-notes').value;
                
                if (!date || !time) {
                    alert('Please select both date and time');
                    return;
                }
                
                const lead = GLOBAL_STATE.currentBookingLead;
                const appointment = {
                    id: Date.now().toString(),
                    leadId: lead.id,
                    leadName: lead.name,
                    agentId: GLOBAL_STATE.currentUser.id,
                    agentName: GLOBAL_STATE.currentUser.name,
                    date, time, notes
                };
                
                GLOBAL_STATE.appointments.push(appointment);
                lead.disposition = 'Appointment Booked';
                
                document.getElementById('booking-modal').classList.add('hidden');
                document.getElementById('booking-modal').style.display = 'none';
                renderAgentUI();
                
                alert('Appointment booked successfully!');
            };
        }

        function renderAgentUI() {
            const allLeads = GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentUser.id] || [];
            const activeLeads = allLeads.filter(l => l.disposition === 'New Lead' || l.disposition === 'Called - No Answer' || l.disposition === 'Called - Voicemail' || l.disposition === 'Call Back Scheduled');
            const agentAppointments = GLOBAL_STATE.appointments.filter(a => a.agentId === GLOBAL_STATE.currentUser.id);
            const closed = allLeads.filter(l => l.disposition === 'Closed');
            
            // Determine which leads to show based on filter
            const leadsToShow = GLOBAL_STATE.agentLeadFilter === 'active' ? activeLeads : allLeads;
            
            document.getElementById('agent-total-leads').textContent = allLeads.length;
            document.getElementById('agent-active-leads').textContent = activeLeads.length;
            document.getElementById('agent-total-appointments').textContent = agentAppointments.length;
            document.getElementById('agent-closed-deals').textContent = closed.length;
            
            // Update filter button styles
            const activeBtn = document.getElementById('filter-active-btn');
            const allBtn = document.getElementById('filter-all-btn');
            if (GLOBAL_STATE.agentLeadFilter === 'active') {
                activeBtn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white';
                allBtn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-white text-gray-700 border border-gray-200';
            } else {
                activeBtn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-white text-gray-700 border border-gray-200';
                allBtn.className = 'px-4 py-2 text-sm font-medium rounded-lg bg-indigo-600 text-white';
            }
            
            const container = document.getElementById('agent-leads-container');
            
            if (leadsToShow.length === 0) {
                const message = GLOBAL_STATE.agentLeadFilter === 'active' 
                    ? 'No active leads remaining!' 
                    : 'No leads assigned yet.';
                const submessage = GLOBAL_STATE.agentLeadFilter === 'active'
                    ? 'Great work! All leads have been processed.'
                    : 'Your administrator will upload leads for you.';
                
                container.innerHTML = `
                    <div class="p-12 text-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-gray-400 font-medium">${message}</p>
                        <p class="text-gray-400 text-sm mt-1">${submessage}</p>
                    </div>`;
            } else {
                container.innerHTML = `
                    <div class="p-4 bg-indigo-50 border-b border-indigo-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="flex items-center justify-center w-10 h-10 bg-indigo-600 text-white rounded-full font-bold">
                                    ${leadsToShow.length}
                                </div>
                                <div>
                                    <p class="text-sm font-bold text-indigo-900">
                                        ${GLOBAL_STATE.agentLeadFilter === 'active' ? 'Active leads to process' : 'Total leads'}
                                    </p>
                                    <p class="text-xs text-indigo-600">Update disposition to mark as processed</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-bold text-indigo-900">${((closed.length / allLeads.length) * 100).toFixed(0)}%</p>
                                <p class="text-xs text-indigo-600">Conversion Rate</p>
                            </div>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-gray-50 text-gray-400 text-xs uppercase font-bold">
                                <tr>
                                    <th class="px-6 py-3 text-left">Name</th>
                                    <th class="px-6 py-3 text-left">Contact</th>
                                    <th class="px-6 py-3 text-left">Status</th>
                                    <th class="px-6 py-3 text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-100">
                                ${leadsToShow.map(lead => `
                                    <tr class="${lead.disposition === 'New Lead' ? 'bg-blue-50' : ''}">
                                        <td class="px-6 py-4">
                                            <div class="font-medium text-gray-900">${lead.name}</div>
                                            ${lead.company ? `<div class="text-xs text-gray-500">${lead.company}</div>` : ''}
                                        </td>
                                        <td class="px-6 py-4">
                                            <div class="text-sm text-gray-600">${lead.email}</div>
                                            <div class="text-xs text-gray-400">${lead.phone}</div>
                                        </td>
                                        <td class="px-6 py-4">
                                            <select onchange="updateDisposition('${lead.id}', this.value)" class="text-xs font-medium px-3 py-1.5 rounded-full border-0 ${getStatusClass(lead.disposition)}">
                                                ${GLOBAL_STATE.dispositions.map(d => `<option value="${d}" ${d === lead.disposition ? 'selected' : ''}>${d}</option>`).join('')}
                                            </select>
                                        </td>
                                        <td class="px-6 py-4 text-right">
                                            <button onclick="bookAppointment('${lead.id}')" class="bg-green-100 hover:bg-green-200 text-green-700 text-sm px-4 py-2 rounded-lg mr-2">
                                                Book
                                            </button>
                                            <button onclick="callLead('${lead.phone}')" class="bg-indigo-100 hover:bg-indigo-200 text-indigo-700 text-sm px-4 py-2 rounded-lg">
                                                Call
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }
        }

        function bookAppointment(leadId) {
            const lead = GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentUser.id].find(l => l.id == leadId);
            GLOBAL_STATE.currentBookingLead = lead;
            document.getElementById('booking-lead-name').textContent = lead.name;
            document.getElementById('booking-date').value = '';
            document.getElementById('booking-time').value = '';
            document.getElementById('booking-notes').value = '';
            
            const modal = document.getElementById('booking-modal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
        }

        function changeAgentMonth(delta) {
            GLOBAL_STATE.calendarView = new Date(GLOBAL_STATE.calendarView.getFullYear(), GLOBAL_STATE.calendarView.getMonth() + delta, 1);
            renderAgentCalendar();
        }

        function renderAgentCalendar() {
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
            document.getElementById('agent-calendar-title').textContent = `${months[GLOBAL_STATE.calendarView.getMonth()]} ${GLOBAL_STATE.calendarView.getFullYear()}`;
            
            const firstDay = new Date(GLOBAL_STATE.calendarView.getFullYear(), GLOBAL_STATE.calendarView.getMonth(), 1);
            const lastDay = new Date(GLOBAL_STATE.calendarView.getFullYear(), GLOBAL_STATE.calendarView.getMonth() + 1, 0);
            const startDay = firstDay.getDay();
            const totalDays = lastDay.getDate();
            
            const myAppointments = GLOBAL_STATE.appointments.filter(a => a.agentId === GLOBAL_STATE.currentUser.id);
            
            let html = '<div class="calendar-grid border-l border-t border-gray-100">';
            const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            dayNames.forEach(day => {
                html += `<div class="bg-gray-50 p-2 text-center text-xs font-bold text-gray-400 uppercase border-r border-b border-gray-100">${day}</div>`;
            });
            
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day border-r border-b border-gray-100 bg-gray-50"></div>';
            }
            
            for (let day = 1; day <= totalDays; day++) {
                const dateStr = `${GLOBAL_STATE.calendarView.getFullYear()}-${String(GLOBAL_STATE.calendarView.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayAppointments = myAppointments.filter(a => a.date === dateStr);
                
                html += `<div class="calendar-day p-2 border-r border-b border-gray-100 bg-white hover:bg-gray-50">
                    <div class="text-sm font-medium text-gray-700 mb-1">${day}</div>`;
                
                dayAppointments.forEach(apt => {
                    html += `<div class="appointment-badge bg-green-100 text-green-700" onclick="showAppointmentDetails('${apt.id}')">${apt.time} - ${apt.leadName}</div>`;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            document.getElementById('agent-calendar-grid').innerHTML = html;
        }

        function getStatusClass(disposition) {
            const map = {
                'New Lead': 'status-new',
                'Called - No Answer': 'status-noanswer',
                'Called - Voicemail': 'status-voicemail',
                'Call Back Scheduled': 'status-callback',
                'Appointment Booked': 'status-appointment',
                'Closed': 'status-closed'
            };
            return map[disposition] || 'bg-gray-100 text-gray-700';
        }

        function updateDisposition(leadId, newDisposition) {
            const leads = GLOBAL_STATE.agentLeads[GLOBAL_STATE.currentUser.id];
            const lead = leads.find(l => l.id == leadId);
            if (lead) {
                lead.disposition = newDisposition;
                renderAgentUI();
                
                // Show success message for processed leads
                if (newDisposition !== 'New Lead') {
                    const activeLeads = leads.filter(l => 
                        l.disposition === 'New Lead' || 
                        l.disposition === 'Called - No Answer' || 
                        l.disposition === 'Called - Voicemail' || 
                        l.disposition === 'Call Back Scheduled'
                    );
                    
                    if (GLOBAL_STATE.agentLeadFilter === 'active' && activeLeads.length > 0) {
                        showToast(`Lead updated! ${activeLeads.length} active leads remaining`);
                    } else if (GLOBAL_STATE.agentLeadFilter === 'active' && activeLeads.length === 0) {
                        showToast('🎉 All leads processed! Great work!', 'success');
                    }
                }
            }
        }

        function setLeadFilter(filter) {
            GLOBAL_STATE.agentLeadFilter = filter;
            renderAgentUI();
        }

        function showToast(message, type = 'info') {
            const existingToast = document.getElementById('toast-notification');
            if (existingToast) existingToast.remove();
            
            const toast = document.createElement('div');
            toast.id = 'toast-notification';
            toast.className = `fixed bottom-6 right-6 z-[200] px-6 py-4 rounded-lg shadow-lg font-medium text-white transform transition-all duration-300 ${
                type === 'success' ? 'bg-green-600' : 'bg-indigo-600'
            }`;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('opacity-0'), 2500);
            setTimeout(() => toast.remove(), 3000);
        }

        function callLead(phone) {
            if (phone) {
                alert(`Calling ${phone}...`);
            } else {
                alert('No phone number available');
            }
        }

        
    </script>
</body>
</html>
